<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>第十二章 内中断 - Pil0tXia 的书房</title>
    <meta name="generator" content="VuePress 1.9.2">
    <link rel="icon" href="https://static.pil0txia.com/assets/favicon.ico">
    <script async="true" src="https://www.googletagmanager.com/gtag/js?id=G-57XMHPB9DW"></script>
    <script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-57XMHPB9DW');</script>
    <meta name="description" content="我的学习笔记和技术分享">
    <meta name="keywords" content="pil0txia,it,docs,note,study">
    <meta name="baidu-site-verification" content="code-f37Lv9IIFX">
    
    <link rel="preload" href="/assets/css/0.styles.021fb583.css" as="style"><link rel="preload" href="/assets/js/app.7c22909a.js" as="script"><link rel="preload" href="/assets/js/2.6758ed52.js" as="script"><link rel="preload" href="/assets/js/56.2b6c22ee.js" as="script"><link rel="prefetch" href="/assets/js/10.e24f1e40.js"><link rel="prefetch" href="/assets/js/11.05cb0029.js"><link rel="prefetch" href="/assets/js/12.32af8044.js"><link rel="prefetch" href="/assets/js/13.700f1625.js"><link rel="prefetch" href="/assets/js/14.41717448.js"><link rel="prefetch" href="/assets/js/15.ecaf38f1.js"><link rel="prefetch" href="/assets/js/16.f4a2e8fe.js"><link rel="prefetch" href="/assets/js/17.dd141a48.js"><link rel="prefetch" href="/assets/js/18.d4b349b0.js"><link rel="prefetch" href="/assets/js/19.e768f6f2.js"><link rel="prefetch" href="/assets/js/20.258fe436.js"><link rel="prefetch" href="/assets/js/21.e2e83218.js"><link rel="prefetch" href="/assets/js/22.fbef3388.js"><link rel="prefetch" href="/assets/js/23.0823fda8.js"><link rel="prefetch" href="/assets/js/24.f2106677.js"><link rel="prefetch" href="/assets/js/25.d1029eac.js"><link rel="prefetch" href="/assets/js/26.de8ada83.js"><link rel="prefetch" href="/assets/js/27.5542150b.js"><link rel="prefetch" href="/assets/js/28.73bc9881.js"><link rel="prefetch" href="/assets/js/29.dfc6d141.js"><link rel="prefetch" href="/assets/js/3.0aad90a7.js"><link rel="prefetch" href="/assets/js/30.875cb1d3.js"><link rel="prefetch" href="/assets/js/31.12e24a9b.js"><link rel="prefetch" href="/assets/js/32.3e6b9414.js"><link rel="prefetch" href="/assets/js/33.ed53d32c.js"><link rel="prefetch" href="/assets/js/34.24759155.js"><link rel="prefetch" href="/assets/js/35.46746eb8.js"><link rel="prefetch" href="/assets/js/36.752fb623.js"><link rel="prefetch" href="/assets/js/37.9fbc624d.js"><link rel="prefetch" href="/assets/js/38.e57c3e9a.js"><link rel="prefetch" href="/assets/js/39.fe320339.js"><link rel="prefetch" href="/assets/js/4.3055ae5e.js"><link rel="prefetch" href="/assets/js/40.2cc14361.js"><link rel="prefetch" href="/assets/js/41.69f063eb.js"><link rel="prefetch" href="/assets/js/42.7e2baa49.js"><link rel="prefetch" href="/assets/js/43.db617122.js"><link rel="prefetch" href="/assets/js/44.a1fc3b4c.js"><link rel="prefetch" href="/assets/js/45.966ef14f.js"><link rel="prefetch" href="/assets/js/46.1b8df3ff.js"><link rel="prefetch" href="/assets/js/47.19f52d31.js"><link rel="prefetch" href="/assets/js/48.99209cdd.js"><link rel="prefetch" href="/assets/js/49.e2fcc246.js"><link rel="prefetch" href="/assets/js/5.e24581f1.js"><link rel="prefetch" href="/assets/js/50.1fb68e50.js"><link rel="prefetch" href="/assets/js/51.8fb412d1.js"><link rel="prefetch" href="/assets/js/52.7f71c13a.js"><link rel="prefetch" href="/assets/js/53.a0638f3f.js"><link rel="prefetch" href="/assets/js/54.197b3a4a.js"><link rel="prefetch" href="/assets/js/55.8f0848d5.js"><link rel="prefetch" href="/assets/js/57.d3b95709.js"><link rel="prefetch" href="/assets/js/58.477eda2a.js"><link rel="prefetch" href="/assets/js/59.e0b4407a.js"><link rel="prefetch" href="/assets/js/6.a90a255b.js"><link rel="prefetch" href="/assets/js/60.02ddfe44.js"><link rel="prefetch" href="/assets/js/7.2fb00079.js"><link rel="prefetch" href="/assets/js/8.a4338d2b.js"><link rel="prefetch" href="/assets/js/9.f988ec8a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.021fb583.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="https://static.pil0txia.com/assets/03_3_600p.webp" alt="Pil0tXia 的书房" class="logo"> <span class="site-name can-hide">Pil0tXia 的书房</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="操作系统课程笔记" class="dropdown-title"><a href="/pages/5719ac/" class="link-title">操作系统课程笔记</a> <span class="title" style="display:none;">操作系统课程笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/d1af54/" class="nav-link">第一章 操作系统引论</a></li><li class="dropdown-item"><!----> <a href="/pages/1f0d42/" class="nav-link">第二章 进程的描述与控制</a></li><li class="dropdown-item"><!----> <a href="/pages/9cf689/" class="nav-link">第三章 处理机调度与死锁</a></li><li class="dropdown-item"><!----> <a href="/pages/1253d7/" class="nav-link">第四章 存储器管理</a></li><li class="dropdown-item"><!----> <a href="/pages/f6080a/" class="nav-link">第五章 虚拟存储器</a></li><li class="dropdown-item"><!----> <a href="/pages/a80c85/" class="nav-link">期末考试备考</a></li></ul></div></div><div class="nav-item"><a href="/asm-notes/shorthand/" class="nav-link">汇编语言课程笔记</a></div> <a href="https://github.com/Pil0tXia/docs" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="操作系统课程笔记" class="dropdown-title"><a href="/pages/5719ac/" class="link-title">操作系统课程笔记</a> <span class="title" style="display:none;">操作系统课程笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/d1af54/" class="nav-link">第一章 操作系统引论</a></li><li class="dropdown-item"><!----> <a href="/pages/1f0d42/" class="nav-link">第二章 进程的描述与控制</a></li><li class="dropdown-item"><!----> <a href="/pages/9cf689/" class="nav-link">第三章 处理机调度与死锁</a></li><li class="dropdown-item"><!----> <a href="/pages/1253d7/" class="nav-link">第四章 存储器管理</a></li><li class="dropdown-item"><!----> <a href="/pages/f6080a/" class="nav-link">第五章 虚拟存储器</a></li><li class="dropdown-item"><!----> <a href="/pages/a80c85/" class="nav-link">期末考试备考</a></li></ul></div></div><div class="nav-item"><a href="/asm-notes/shorthand/" class="nav-link">汇编语言课程笔记</a></div> <a href="https://github.com/Pil0tXia/docs" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>汇编语言课程笔记</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/asm-notes/shorthand/" class="sidebar-link">课堂速记</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>《汇编语言》第三版阅读笔记</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/e44e75/" class="sidebar-link">第一章 基础知识</a></li><li><a href="/pages/ea8c9c/" class="sidebar-link">第二章 寄存器</a></li><li><a href="/pages/252f3a/" class="sidebar-link">第三章 寄存器（内存访问）</a></li><li><a href="/pages/310d5a/" class="sidebar-link">第四章 第一个程序</a></li><li><a href="/pages/a97f13/" class="sidebar-link">第五章 [BX]和loop指令</a></li><li><a href="/pages/f2f815/" class="sidebar-link">第六章 包含多个段的程序</a></li><li><a href="/pages/a1378c/" class="sidebar-link">第七章 更灵活的定位内存地址的方法</a></li><li><a href="/pages/02c62b/" class="sidebar-link">第八章 数据处理的两个基本问题</a></li><li><a href="/pages/83284e/" class="sidebar-link">第九章 转移指令的原理</a></li><li><a href="/pages/a0c561/" class="sidebar-link">第十章 CALL和RET指令</a></li><li><a href="/pages/3d86c5/" class="sidebar-link">第十一章 标志寄存器</a></li><li><a href="/pages/27a5f0/" aria-current="page" class="active sidebar-link">第十二章 内中断</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/27a5f0/#_12-1-内中断的产生" class="sidebar-link">12.1 内中断的产生</a></li><li class="sidebar-sub-header level2"><a href="/pages/27a5f0/#_12-2-中断处理程序" class="sidebar-link">12.2 中断处理程序</a></li><li class="sidebar-sub-header level2"><a href="/pages/27a5f0/#_12-3-中断向量表" class="sidebar-link">12.3 中断向量表</a></li><li class="sidebar-sub-header level2"><a href="/pages/27a5f0/#_12-4-中断过程" class="sidebar-link">12.4 中断过程</a></li><li class="sidebar-sub-header level2"><a href="/pages/27a5f0/#_12-5-中断处理程序和iret指令" class="sidebar-link">12.5 中断处理程序和iret指令</a></li><li class="sidebar-sub-header level2"><a href="/pages/27a5f0/#_12-6-除法错误中断的处理" class="sidebar-link">12.6 除法错误中断的处理</a></li><li class="sidebar-sub-header level2"><a href="/pages/27a5f0/#_12-7-编程处理0号中断" class="sidebar-link">12.7 编程处理0号中断</a></li><li class="sidebar-sub-header level2"><a href="/pages/27a5f0/#_12-8-安装" class="sidebar-link">12.8 安装</a></li><li class="sidebar-sub-header level2"><a href="/pages/27a5f0/#_12-9-do0" class="sidebar-link">12.9 do0</a></li><li class="sidebar-sub-header level2"><a href="/pages/27a5f0/#_12-10-设置中断向量" class="sidebar-link">12.10 设置中断向量</a></li><li class="sidebar-sub-header level2"><a href="/pages/27a5f0/#_12-11-单步中断" class="sidebar-link">12.11 单步中断</a></li><li class="sidebar-sub-header level2"><a href="/pages/27a5f0/#_12-12-响应中断的特殊情况" class="sidebar-link">12.12 响应中断的特殊情况</a></li></ul></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><span data-v-06225672>汇编语言</span></li><li data-v-06225672><span data-v-06225672>《汇编语言》第三版阅读笔记</span></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://www.pil0txia.com" target="_blank" title="作者" class="beLink" data-v-06225672>Pil0tXia</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2023-01-05</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><!---->第十二章 内中断<!----></h1> <!----> <div class="theme-vdoing-content content__default"><h1 id="第十二章-内中断"><a href="#第十二章-内中断" class="header-anchor">#</a> <strong>第十二章 内中断</strong></h1> <p>什么是中断？如果你学习过高级编程语言，可以将中断理解为异常的特殊处理过程，就像 Java 里面的 Exception。</p> <p>任何一个通用的 CPU，都具备一种能力，可以在执行完当前正在执行的指令之后，检测从 CPU 外部发送过来的或内部产生的一种特殊信息，并且可以立即对所收到的信息进行处理。这种特殊信息，我们可以称其为：中断信息。中断的意思是指，CPU 不在接着 (刚执行完的指令) 向下执行，而是转去处理这个特殊信息。</p> <p>中断信息可以来自 CPU 内部和外部，这一章，我们主要讨论来自 CPU 内部的中断信息，我们称之为内中断。</p> <h2 id="_12-1-内中断的产生"><a href="#_12-1-内中断的产生" class="header-anchor">#</a> <strong>12.1 内中断的产生</strong></h2> <p>8086CPU 使用单元字节大小的数字来标识中断类型。</p> <p>CPU 内部可能产生多种多样的中断，那么应该如何来标识是哪种中断呢，或者说我们如何确定中断源？<br>
8086CPU 用称为<strong>中断类型码</strong>的数据来标识中断信息的来源。中断类型码为一个字节型数据，可以表示 256 种中断类型。以后，我们将产生中断信息的事件，即中断信息的来源，称之为<strong>中断源</strong>。</p> <h2 id="_12-2-中断处理程序"><a href="#_12-2-中断处理程序" class="header-anchor">#</a> <strong>12.2 中断处理程序</strong></h2> <p>处理中断信息的程序被称为<strong>中断处理程序</strong>。</p> <h2 id="_12-3-中断向量表"><a href="#_12-3-中断向量表" class="header-anchor">#</a> <strong>12.3 中断向量表</strong></h2> <p>中断发生后，CPU 要根据中断类型码去执行对应的中断处理程序？但如何根据 8 位的中断类型码得到中断处理程序的地址呢？</p> <p>实际上，8086CPU 用 8 位的中断类型码通过<strong>中断向量表</strong>找到相应的中断处理程序的入口地址。中断向量表就是中断处理程序入口地址的列表，列表的下标索引（从 0 开始）即是中断类型码的值。中断向量表实际上是中断类型码与中断处理程序入口地址之间的一种映射关系。可以理解为高级编程语言中的 Map 集合。</p> <p>8086CPU 中断向量表指定放在内存 0 处。每个表项占用 4 个字节，高位字存放段地址，低位字存放偏移地址。</p> <h2 id="_12-4-中断过程"><a href="#_12-4-中断过程" class="header-anchor">#</a> <strong>12.4 中断过程</strong></h2> <p>用中断类型码找到中断向量，并用它设置 CS 和 IP 的值，这个工作是由 CPU 的硬件自动完成的。CPU 硬件完成这个工作的过程被称为<strong>中断过程</strong>。中断过程完成后，CPU 就会开始执行中断处理程序。中断过程可以理解为中断环境的初始化。那么在 CPU 进行中断过程中需要准备哪些工作呢？概括来说，主要进行以下六步准备工作：</p> <p>（1）(从中断信息中) 取得中断类型码；<br>
（2）标志寄存器的值入栈 (因为在中断过程中要改变标志寄存器的值，所以先将其保存在栈中)；<br>
（3）设置标志寄存器的第 8 位 TF 和第 9 位 IF 的值为 0 (这一步的目的后面将介绍)；<br>
（4）CS 的内容入栈；<br>
（5）IP 的内容入栈；<br>
（6）从内存地址为中断类型码<em> 4 和中断类型码</em> 4+2 的两个字单元中读取中断处理程序的入口地址设置 IP 和 CS。</p> <h2 id="_12-5-中断处理程序和iret指令"><a href="#_12-5-中断处理程序和iret指令" class="header-anchor">#</a> <strong>12.5 中断处理程序和 iret 指令</strong></h2> <p>中断处理程序必须一直存储在指定内存中，以应对随时可能发生的中断事件。</p> <p>中断处理程序的编写方法和子程序比较相似，下面是常规步骤：</p> <p>（1）保存用到的寄存器；<br>
（2）处理中断；<br>
（3）恢复用到的寄存器；<br>
（4）用 ret 指令返回。</p> <p>iret 指令的功能用汇编语法描述为：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>pop IP
pop CS
popf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>在中断过程中，注意标志寄存器入栈和出栈的次序。入栈顺序是标志寄存器、CS、IP，出栈顺序与此相反。</p> <h2 id="_12-6-除法错误中断的处理"><a href="#_12-6-除法错误中断的处理" class="header-anchor">#</a> <strong>12.6 除法错误中断的处理</strong></h2> <p>除法错误将引发 0 号中断。至于为何是 0 号中断，我估摸着除法中断时人们最容易想到也最容易遇到的中断了吧。</p> <h2 id="_12-7-编程处理0号中断"><a href="#_12-7-编程处理0号中断" class="header-anchor">#</a> <strong>12.7 编程处理 0 号中断</strong></h2> <p>我们的需求是重新编写一个 0 号中断处理程序，它的功能是在屏幕中间显示 “overflow!”，然后返回到操作系统。</p> <p>为了满足以上需求，需要做一下几件事情：</p> <p>（1）编写可以显示 “overflow” 的中断处理程序：do0；<br>
（2）将 do0 送入内存 0000:0200 处；<br>
（3）将 do0 的入口地址 0000:0200 存储在中断向量表 0 号表项中。</p> <p>程序的框架如下：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>assume cs<span class="token operator">:</span>code

code segment

start<span class="token operator">:</span>  do0安装程序
        设置中断向量表
        mov ax<span class="token punctuation">,</span> <span class="token number">4</span>c00h
        <span class="token keyword">int</span> <span class="token number">21</span>h

do0<span class="token operator">:</span>    显示字符串<span class="token string">&quot;overflow&quot;</span>
        mov ax<span class="token punctuation">,</span> <span class="token number">4</span>c00h
        <span class="token keyword">int</span> <span class="token number">21</span>h

code ends

end start
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>下面摘抄书中比较精辟的一段总结：</p> <blockquote><p>我们如何让一个内存单元成为栈顶？将它的地址放入 SS、SP 中；<br>
我们如何让一个内存单元中的信息被 CPU 当做指令来执行？将它的地址放入 CS、IP 中；
我们如何让一个内存单元成为要处理的数据？将它的段地址放在 DS 中；(书中无这句话，个人根据理解补充)<br>
 那么，我们如何让一段程序成为 N 号中断的中断处理程序呢？将它的入口地址放入中断向量表的 N 好表项中。</p></blockquote> <h2 id="_12-8-安装"><a href="#_12-8-安装" class="header-anchor">#</a> <strong>12.8 安装</strong></h2> <p>所谓安装就是将中断处理程序 (do0) 送到指定内存处。</p> <p>我们可以使用 movsb 指令，将 do0 的代码送入 0:200 处。复习一下 movsb 的用法：movsb 是串传送指令，其功能是将 ds:si 指向的内存单元中的字节送入 es:di 中，并根据标志寄存器 df 的值，将 si 和 di 递增或递减。movsb 指令往往与 rep 指令配合使用来实现批量字符串的传送。</p> <p>安装程序的框架如下所示：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>assume cs<span class="token operator">:</span>code
code segment

start<span class="token operator">:</span>  设置es<span class="token operator">:</span>di指向目的地址
        设置ds<span class="token operator">:</span>si指向源地址
        设置cx为传输长度
        设置传输方向为正
        rep movsb

        设置中断向量表

        mov ax<span class="token punctuation">,</span> <span class="token number">4</span>c00h
        <span class="token keyword">int</span> <span class="token number">21</span>h

do0<span class="token operator">:</span>    显示字符串<span class="token string">&quot;overflow!&quot;</span>
        mov ax<span class="token punctuation">,</span> <span class="token number">4</span>c00h
        <span class="token keyword">int</span> <span class="token number">21</span>h

code ends
end start

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>以上步骤的难点在于如何确认中断处理程序 do0 的长度？最笨的方法是计算 do0 中每句代码的长度，然后累加，但这样做太麻烦了，不仅要知道每行代码所占的字节数，代码稍有改动那就令人抓狂。书中作者给出一个非常简便的计算方式，利用编译器来帮助我们计算 do0 的长度。之前我们学过 offset 指令，他的功能是取得标号的偏移地址，我们在 do0 后面在添加一个标号 do0end，使用 offset do0end - offset do0 即可计算出 do0 的长度。</p> <p>解决了字符传送以及确认 do0 长度这两个拦路虎后，我们就可以看一下较为完整的安装程序代码了：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>assume cs<span class="token operator">:</span>code
code segment
start<span class="token operator">:</span>  
        mov ax<span class="token punctuation">,</span> cs
        mov ds<span class="token punctuation">,</span> ax
        mov si<span class="token punctuation">,</span> offset do0        <span class="token punctuation">;</span>设置ds<span class="token operator">:</span>si指向源地址
        mov ax<span class="token punctuation">,</span> <span class="token number">0</span>
        mov es<span class="token punctuation">,</span> ax                
        mov di<span class="token punctuation">,</span> <span class="token number">0200</span>h             <span class="token punctuation">;</span>设置es<span class="token operator">:</span>di指向目标地址

        mov cx<span class="token punctuation">,</span> offset do0end <span class="token operator">-</span> offset do0  <span class="token punctuation">;</span>设置cx为传输长度
        cld                                 <span class="token punctuation">;</span>设置传输方向为正
        rep movsb                           <span class="token punctuation">;</span>传输开始

        设置中断向量表

        mov ax<span class="token punctuation">,</span> <span class="token number">4</span>c00H
        <span class="token keyword">int</span> <span class="token number">21</span>H

do0<span class="token operator">:</span>    显示字符串<span class="token string">&quot;overflow!&quot;</span>
        mov ax<span class="token punctuation">,</span> <span class="token number">4</span>c00h
        <span class="token keyword">int</span> <span class="token number">21</span>h
code ends

end start

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>这里补充一点，像 &quot;+&quot;、&quot;-&quot;、&quot;*&quot;、&quot;/&quot;、&quot;offset&quot; 这类指令都是伪指令，并不是标准的汇编指令，它是由编译器识别并由编译器翻译为对应的汇编指令。</p> <h2 id="_12-9-do0"><a href="#_12-9-do0" class="header-anchor">#</a> <strong>12.9 do0</strong></h2> <p>do0 程序即是我们的 0 号中断处理程序。其主要目的是显示字符串 &quot;overflow!&quot;。</p> <p>主要程序代码如下所示：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>do0<span class="token operator">:</span>    jum <span class="token keyword">short</span> do0start
        db <span class="token char">'overflow!'</span>

do0start<span class="token operator">:</span> mov ax<span class="token punctuation">,</span> cs
          mov ds<span class="token punctuation">,</span> ax
          mov si<span class="token punctuation">,</span> <span class="token number">202</span>h

          mov ax<span class="token punctuation">,</span> <span class="token number">0</span>b800h
          mov es<span class="token punctuation">,</span> ax
          mov di<span class="token punctuation">,</span> <span class="token number">12</span><span class="token operator">*</span><span class="token number">160</span> <span class="token operator">+</span> <span class="token number">36</span><span class="token operator">*</span><span class="token number">2</span>

          mov cx<span class="token punctuation">,</span> <span class="token number">9</span>
        s<span class="token operator">:</span>mov al<span class="token punctuation">,</span> <span class="token punctuation">[</span>si<span class="token punctuation">]</span>
          mov es<span class="token operator">:</span><span class="token punctuation">[</span>di<span class="token punctuation">]</span><span class="token punctuation">,</span> al
          inc si
          add di<span class="token punctuation">,</span> <span class="token number">2</span>
          loop s

          mov ax<span class="token punctuation">,</span> <span class="token number">4</span>c00h
          <span class="token keyword">int</span> <span class="token number">21</span>h

do0end<span class="token operator">:</span>   nop
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>这部分代码需要注意的地方是，我们在子程序 do0 开始处定义了字符串 &quot;overflow!&quot;，但它并不是可以执行的代码，所以在 &quot;overflow!&quot; 之前加上一条 jmp 指令，转移到正式的 do0 程序。</p> <h2 id="_12-10-设置中断向量"><a href="#_12-10-设置中断向量" class="header-anchor">#</a> <strong>12.10 设置中断向量</strong></h2> <p>设置中断向量，也即是将中断处理程序 do0 在内存中的入口地址存放在中断向量表 0 号表项中。0 号表项的地址为 0:0，其中 0:0 字单元存放中断处理程序入口地址的偏移地址，0:2 字单元存放中断处理程序入口地址的段地址。程序如下：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>mov ax<span class="token punctuation">,</span> <span class="token number">0</span>
mov es<span class="token punctuation">,</span> ax
mov word ptr es<span class="token operator">:</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">200</span>h
mov word ptr es<span class="token operator">:</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token operator">*</span><span class="token number">4</span><span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="_12-11-单步中断"><a href="#_12-11-单步中断" class="header-anchor">#</a> <strong>12.11 单步中断</strong></h2> <p>基本上，在 CPU 执行完一条指令之后，如果检测到标志寄存器的 TF 位为 1，则产生单步中断，引发中断过程。单步中断的中断类型码为 1。在一开始我们说 CPU 在执行中断处理程序之前要先将标志寄存器 TF 位置 0，这就是为了防止 CPU 在执行 1 号类型中断 (单步中断) 时无限递归执行中断。</p> <p>CPU 提供单步中断功能的出发点是，为单步跟踪程序的执行过程，提供了实现机制。</p> <h2 id="_12-12-响应中断的特殊情况"><a href="#_12-12-响应中断的特殊情况" class="header-anchor">#</a> <strong>12.12 响应中断的特殊情况</strong></h2> <blockquote><p>一般情况下，CPU 在执行完当前指令后，如果检测到中断信息，就响应中断，引发中断过程。可是，在有些情况下，CPU 执行完当前指令后，即便是发生中断，也不会响应。例如针对 ss 修改执行后，下一条指令 (一般是修改 sp) 也会紧接着执行，中间即使发生中断，CPU 也不会去响应。这样做的主要原因是，ss:sp 联合指向栈顶，而对它们的设置应该连续完成。如果在执行完设置 ss 的指令后，CPU 响应中断，引发中断过程，要在栈中压入标志寄存器、CS 和 IP 的值，而 ss 改变，sp 并未改变，<strong>ss:sp 指向的不是正确的栈顶</strong>，将引起错误。</p></blockquote> <p>这种理念在高级编程语言中的具体体现是 “原子操作”，即一组操作要么不执行，要么就一次执行完毕，不会存在中间状态。</p> <blockquote><p>上课没有时间详细记笔记，复习阶段参考了<a href="https://github.com/sanmianti/AssemblyLanguageTest" target="_blank" rel="noopener noreferrer"> sanmianti/AssemblyLanguageTest<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，感谢。</p></blockquote></div></div> <!----> <div class="page-edit"><!----> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2023/01/06, 19:28:46</span></div></div> <div class="page-nav-wapper"><!----> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/3d86c5/" class="prev">第十一章 标志寄存器</a></span> <!----></p></div></div></div> <!----></main></div> <div class="footer"><div class="icons"><a href="https://www.pil0txia.com" title="Blog" target="_blank" class="iconfont icon-shuben"></a><a href="https://github.com/Pil0tXia" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="mailto:admin@pil0txia.com" title="Contact Me" target="_blank" class="iconfont icon-youjian"></a></div> 
    Copyright © 2022-2023
    <span>Pil0tXia | CC BY-NC-SA 4.0 Licensed | <a href="https://beian.miit.gov.cn/" target="_blank">苏ICP备2023001491号-1</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.7c22909a.js" defer></script><script src="/assets/js/2.6758ed52.js" defer></script><script src="/assets/js/56.2b6c22ee.js" defer></script>
  </body>
</html>
