(window.webpackJsonp=window.webpackJsonp||[]).push([[56],{382:function(s,a,n){"use strict";n.r(a);var t=n(7),r=Object(t.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"第十二章-内中断"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#第十二章-内中断"}},[s._v("#")]),s._v(" "),a("strong",[s._v("第十二章 内中断")])]),s._v(" "),a("p",[s._v("什么是中断？如果你学习过高级编程语言，可以将中断理解为异常的特殊处理过程，就像 Java 里面的 Exception。")]),s._v(" "),a("p",[s._v("任何一个通用的 CPU，都具备一种能力，可以在执行完当前正在执行的指令之后，检测从 CPU 外部发送过来的或内部产生的一种特殊信息，并且可以立即对所收到的信息进行处理。这种特殊信息，我们可以称其为：中断信息。中断的意思是指，CPU 不在接着 (刚执行完的指令) 向下执行，而是转去处理这个特殊信息。")]),s._v(" "),a("p",[s._v("中断信息可以来自 CPU 内部和外部，这一章，我们主要讨论来自 CPU 内部的中断信息，我们称之为内中断。")]),s._v(" "),a("h2",{attrs:{id:"_12-1-内中断的产生"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_12-1-内中断的产生"}},[s._v("#")]),s._v(" "),a("strong",[s._v("12.1 内中断的产生")])]),s._v(" "),a("p",[s._v("8086CPU 使用单元字节大小的数字来标识中断类型。")]),s._v(" "),a("p",[s._v("CPU 内部可能产生多种多样的中断，那么应该如何来标识是哪种中断呢，或者说我们如何确定中断源？"),a("br"),s._v("\n8086CPU 用称为"),a("strong",[s._v("中断类型码")]),s._v("的数据来标识中断信息的来源。中断类型码为一个字节型数据，可以表示 256 种中断类型。以后，我们将产生中断信息的事件，即中断信息的来源，称之为"),a("strong",[s._v("中断源")]),s._v("。")]),s._v(" "),a("h2",{attrs:{id:"_12-2-中断处理程序"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_12-2-中断处理程序"}},[s._v("#")]),s._v(" "),a("strong",[s._v("12.2 中断处理程序")])]),s._v(" "),a("p",[s._v("处理中断信息的程序被称为"),a("strong",[s._v("中断处理程序")]),s._v("。")]),s._v(" "),a("h2",{attrs:{id:"_12-3-中断向量表"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_12-3-中断向量表"}},[s._v("#")]),s._v(" "),a("strong",[s._v("12.3 中断向量表")])]),s._v(" "),a("p",[s._v("中断发生后，CPU 要根据中断类型码去执行对应的中断处理程序？但如何根据 8 位的中断类型码得到中断处理程序的地址呢？")]),s._v(" "),a("p",[s._v("实际上，8086CPU 用 8 位的中断类型码通过"),a("strong",[s._v("中断向量表")]),s._v("找到相应的中断处理程序的入口地址。中断向量表就是中断处理程序入口地址的列表，列表的下标索引（从 0 开始）即是中断类型码的值。中断向量表实际上是中断类型码与中断处理程序入口地址之间的一种映射关系。可以理解为高级编程语言中的 Map 集合。")]),s._v(" "),a("p",[s._v("8086CPU 中断向量表指定放在内存 0 处。每个表项占用 4 个字节，高位字存放段地址，低位字存放偏移地址。")]),s._v(" "),a("h2",{attrs:{id:"_12-4-中断过程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_12-4-中断过程"}},[s._v("#")]),s._v(" "),a("strong",[s._v("12.4 中断过程")])]),s._v(" "),a("p",[s._v("用中断类型码找到中断向量，并用它设置 CS 和 IP 的值，这个工作是由 CPU 的硬件自动完成的。CPU 硬件完成这个工作的过程被称为"),a("strong",[s._v("中断过程")]),s._v("。中断过程完成后，CPU 就会开始执行中断处理程序。中断过程可以理解为中断环境的初始化。那么在 CPU 进行中断过程中需要准备哪些工作呢？概括来说，主要进行以下六步准备工作：")]),s._v(" "),a("p",[s._v("（1）(从中断信息中) 取得中断类型码；"),a("br"),s._v("\n（2）标志寄存器的值入栈 (因为在中断过程中要改变标志寄存器的值，所以先将其保存在栈中)；"),a("br"),s._v("\n（3）设置标志寄存器的第 8 位 TF 和第 9 位 IF 的值为 0 (这一步的目的后面将介绍)；"),a("br"),s._v("\n（4）CS 的内容入栈；"),a("br"),s._v("\n（5）IP 的内容入栈；"),a("br"),s._v("\n（6）从内存地址为中断类型码"),a("em",[s._v(" 4 和中断类型码")]),s._v(" 4+2 的两个字单元中读取中断处理程序的入口地址设置 IP 和 CS。")]),s._v(" "),a("h2",{attrs:{id:"_12-5-中断处理程序和iret指令"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_12-5-中断处理程序和iret指令"}},[s._v("#")]),s._v(" "),a("strong",[s._v("12.5 中断处理程序和 iret 指令")])]),s._v(" "),a("p",[s._v("中断处理程序必须一直存储在指定内存中，以应对随时可能发生的中断事件。")]),s._v(" "),a("p",[s._v("中断处理程序的编写方法和子程序比较相似，下面是常规步骤：")]),s._v(" "),a("p",[s._v("（1）保存用到的寄存器；"),a("br"),s._v("\n（2）处理中断；"),a("br"),s._v("\n（3）恢复用到的寄存器；"),a("br"),s._v("\n（4）用 ret 指令返回。")]),s._v(" "),a("p",[s._v("iret 指令的功能用汇编语法描述为：")]),s._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[s._v("pop IP\npop CS\npopf\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")]),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("在中断过程中，注意标志寄存器入栈和出栈的次序。入栈顺序是标志寄存器、CS、IP，出栈顺序与此相反。")]),s._v(" "),a("h2",{attrs:{id:"_12-6-除法错误中断的处理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_12-6-除法错误中断的处理"}},[s._v("#")]),s._v(" "),a("strong",[s._v("12.6 除法错误中断的处理")])]),s._v(" "),a("p",[s._v("除法错误将引发 0 号中断。至于为何是 0 号中断，我估摸着除法中断时人们最容易想到也最容易遇到的中断了吧。")]),s._v(" "),a("h2",{attrs:{id:"_12-7-编程处理0号中断"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_12-7-编程处理0号中断"}},[s._v("#")]),s._v(" "),a("strong",[s._v("12.7 编程处理 0 号中断")])]),s._v(" "),a("p",[s._v("我们的需求是重新编写一个 0 号中断处理程序，它的功能是在屏幕中间显示 “overflow!”，然后返回到操作系统。")]),s._v(" "),a("p",[s._v("为了满足以上需求，需要做一下几件事情：")]),s._v(" "),a("p",[s._v("（1）编写可以显示 “overflow” 的中断处理程序：do0；"),a("br"),s._v("\n（2）将 do0 送入内存 0000:0200 处；"),a("br"),s._v("\n（3）将 do0 的入口地址 0000:0200 存储在中断向量表 0 号表项中。")]),s._v(" "),a("p",[s._v("程序的框架如下：")]),s._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[s._v("assume cs"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("code\n\ncode segment\n\nstart"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("  do0安装程序\n        设置中断向量表\n        mov ax"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("c00h\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v("h\n\ndo0"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("    显示字符串"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"overflow"')]),s._v("\n        mov ax"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("c00h\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v("h\n\ncode ends\n\nend start\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br")]),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br")])]),a("p",[s._v("下面摘抄书中比较精辟的一段总结：")]),s._v(" "),a("blockquote",[a("p",[s._v("我们如何让一个内存单元成为栈顶？将它的地址放入 SS、SP 中；"),a("br"),s._v("\n我们如何让一个内存单元中的信息被 CPU 当做指令来执行？将它的地址放入 CS、IP 中；\n我们如何让一个内存单元成为要处理的数据？将它的段地址放在 DS 中；(书中无这句话，个人根据理解补充)"),a("br"),s._v("\n 那么，我们如何让一段程序成为 N 号中断的中断处理程序呢？将它的入口地址放入中断向量表的 N 好表项中。")])]),s._v(" "),a("h2",{attrs:{id:"_12-8-安装"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_12-8-安装"}},[s._v("#")]),s._v(" "),a("strong",[s._v("12.8 安装")])]),s._v(" "),a("p",[s._v("所谓安装就是将中断处理程序 (do0) 送到指定内存处。")]),s._v(" "),a("p",[s._v("我们可以使用 movsb 指令，将 do0 的代码送入 0:200 处。复习一下 movsb 的用法：movsb 是串传送指令，其功能是将 ds:si 指向的内存单元中的字节送入 es:di 中，并根据标志寄存器 df 的值，将 si 和 di 递增或递减。movsb 指令往往与 rep 指令配合使用来实现批量字符串的传送。")]),s._v(" "),a("p",[s._v("安装程序的框架如下所示：")]),s._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[s._v("assume cs"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("code\ncode segment\n\nstart"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("  设置es"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("di指向目的地址\n        设置ds"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("si指向源地址\n        设置cx为传输长度\n        设置传输方向为正\n        rep movsb\n\n        设置中断向量表\n\n        mov ax"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("c00h\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v("h\n\ndo0"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("    显示字符串"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"overflow!"')]),s._v("\n        mov ax"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("c00h\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v("h\n\ncode ends\nend start\n\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br")]),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br")])]),a("p",[s._v("以上步骤的难点在于如何确认中断处理程序 do0 的长度？最笨的方法是计算 do0 中每句代码的长度，然后累加，但这样做太麻烦了，不仅要知道每行代码所占的字节数，代码稍有改动那就令人抓狂。书中作者给出一个非常简便的计算方式，利用编译器来帮助我们计算 do0 的长度。之前我们学过 offset 指令，他的功能是取得标号的偏移地址，我们在 do0 后面在添加一个标号 do0end，使用 offset do0end - offset do0 即可计算出 do0 的长度。")]),s._v(" "),a("p",[s._v("解决了字符传送以及确认 do0 长度这两个拦路虎后，我们就可以看一下较为完整的安装程序代码了：")]),s._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[s._v("assume cs"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("code\ncode segment\nstart"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("  \n        mov ax"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" cs\n        mov ds"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ax\n        mov si"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" offset do0        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("设置ds"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("si指向源地址\n        mov ax"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n        mov es"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ax                \n        mov di"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0200")]),s._v("h             "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("设置es"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("di指向目标地址\n\n        mov cx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" offset do0end "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" offset do0  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("设置cx为传输长度\n        cld                                 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("设置传输方向为正\n        rep movsb                           "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("传输开始\n\n        设置中断向量表\n\n        mov ax"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("c00H\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v("H\n\ndo0"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("    显示字符串"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"overflow!"')]),s._v("\n        mov ax"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("c00h\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v("h\ncode ends\n\nend start\n\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br")]),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br")])]),a("p",[s._v('这里补充一点，像 "+"、"-"、"*"、"/"、"offset" 这类指令都是伪指令，并不是标准的汇编指令，它是由编译器识别并由编译器翻译为对应的汇编指令。')]),s._v(" "),a("h2",{attrs:{id:"_12-9-do0"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_12-9-do0"}},[s._v("#")]),s._v(" "),a("strong",[s._v("12.9 do0")])]),s._v(" "),a("p",[s._v('do0 程序即是我们的 0 号中断处理程序。其主要目的是显示字符串 "overflow!"。')]),s._v(" "),a("p",[s._v("主要程序代码如下所示：")]),s._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[s._v("do0"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("    jum "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("short")]),s._v(" do0start\n        db "),a("span",{pre:!0,attrs:{class:"token char"}},[s._v("'overflow!'")]),s._v("\n\ndo0start"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" mov ax"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" cs\n          mov ds"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ax\n          mov si"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("202")]),s._v("h\n\n          mov ax"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("b800h\n          mov es"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ax\n          mov di"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("160")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("36")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n\n          mov cx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v("\n        s"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("mov al"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("si"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n          mov es"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("di"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" al\n          inc si\n          add di"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n          loop s\n\n          mov ax"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("c00h\n          "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v("h\n\ndo0end"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("   nop\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br")]),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br")])]),a("p",[s._v('这部分代码需要注意的地方是，我们在子程序 do0 开始处定义了字符串 "overflow!"，但它并不是可以执行的代码，所以在 "overflow!" 之前加上一条 jmp 指令，转移到正式的 do0 程序。')]),s._v(" "),a("h2",{attrs:{id:"_12-10-设置中断向量"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_12-10-设置中断向量"}},[s._v("#")]),s._v(" "),a("strong",[s._v("12.10 设置中断向量")])]),s._v(" "),a("p",[s._v("设置中断向量，也即是将中断处理程序 do0 在内存中的入口地址存放在中断向量表 0 号表项中。0 号表项的地址为 0:0，其中 0:0 字单元存放中断处理程序入口地址的偏移地址，0:2 字单元存放中断处理程序入口地址的段地址。程序如下：")]),s._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[s._v("mov ax"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nmov es"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ax\nmov word ptr es"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),s._v("h\nmov word ptr es"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")]),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("h2",{attrs:{id:"_12-11-单步中断"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_12-11-单步中断"}},[s._v("#")]),s._v(" "),a("strong",[s._v("12.11 单步中断")])]),s._v(" "),a("p",[s._v("基本上，在 CPU 执行完一条指令之后，如果检测到标志寄存器的 TF 位为 1，则产生单步中断，引发中断过程。单步中断的中断类型码为 1。在一开始我们说 CPU 在执行中断处理程序之前要先将标志寄存器 TF 位置 0，这就是为了防止 CPU 在执行 1 号类型中断 (单步中断) 时无限递归执行中断。")]),s._v(" "),a("p",[s._v("CPU 提供单步中断功能的出发点是，为单步跟踪程序的执行过程，提供了实现机制。")]),s._v(" "),a("h2",{attrs:{id:"_12-12-响应中断的特殊情况"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_12-12-响应中断的特殊情况"}},[s._v("#")]),s._v(" "),a("strong",[s._v("12.12 响应中断的特殊情况")])]),s._v(" "),a("blockquote",[a("p",[s._v("一般情况下，CPU 在执行完当前指令后，如果检测到中断信息，就响应中断，引发中断过程。可是，在有些情况下，CPU 执行完当前指令后，即便是发生中断，也不会响应。例如针对 ss 修改执行后，下一条指令 (一般是修改 sp) 也会紧接着执行，中间即使发生中断，CPU 也不会去响应。这样做的主要原因是，ss:sp 联合指向栈顶，而对它们的设置应该连续完成。如果在执行完设置 ss 的指令后，CPU 响应中断，引发中断过程，要在栈中压入标志寄存器、CS 和 IP 的值，而 ss 改变，sp 并未改变，"),a("strong",[s._v("ss:sp 指向的不是正确的栈顶")]),s._v("，将引起错误。")])]),s._v(" "),a("p",[s._v("这种理念在高级编程语言中的具体体现是 “原子操作”，即一组操作要么不执行，要么就一次执行完毕，不会存在中间状态。")]),s._v(" "),a("blockquote",[a("p",[s._v("上课没有时间详细记笔记，复习阶段参考了"),a("a",{attrs:{href:"https://github.com/sanmianti/AssemblyLanguageTest",target:"_blank",rel:"noopener noreferrer"}},[s._v(" sanmianti/AssemblyLanguageTest"),a("OutboundLink")],1),s._v("，感谢。")])])])}),[],!1,null,null,null);a.default=r.exports}}]);